generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  name                String
  created_at          DateTime             @default(now())
  chatMessages        ChatMessage[]
  connections         Connection[]
  executions          Execution[]
  workflows           Workflows[]
  memoryCategories    MemoryCategory[]
  memoryItems         MemoryItem[]
  knowledge           Knowledge[]
  memoryActionsTaken  MemoryActionsTaken[]
  memoryStrategies    MemoryStrategy[]
  memoryAutomations   MemoryAutomation[]
  memoryPainPoints    MemoryPainPoint[]
  memoryOpportunities MemoryOpportunity[]
  memoryRoadmaps      MemoryRoadmap[]
}

model Workflows {
  id                String             @id @default(uuid())
  user_id           String
  name              String
  description       String?
  intent            String?
  trigger           Json?
  actions           Json?
  active            Boolean            @default(true)
  n8n_workflow_id   String?
  created_at        DateTime           @default(now())
  executions        Execution[]
  memoryAutomations MemoryAutomation[]
  user              User               @relation(fields: [user_id], references: [id])

  @@map("workflows")
}

model Execution {
  id          String    @id @default(uuid())
  workflow_id String
  user_id     String
  input_data  Json?
  output_data Json?
  created_at  DateTime  @default(now())
  finished_at DateTime?
  user        User      @relation(fields: [user_id], references: [id])
  workflow    Workflows @relation(fields: [workflow_id], references: [id])
}

model Connection {
  id           String   @id @default(uuid())
  user_id      String
  service_name String
  credentials  Json?
  created_at   DateTime @default(now())
  user         User     @relation(fields: [user_id], references: [id])
}

model ChatMessage {
  id         String   @id @default(uuid())
  user_id    String
  role       String
  message    String
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id])
}

model MemoryCategory {
  id          String       @id @default(uuid())
  user_id     String
  name        String
  description String?
  created_at  DateTime     @default(now())
  user        User         @relation(fields: [user_id], references: [id])
  items       MemoryItem[]
}

model MemoryItem {
  id          String         @id @default(uuid())
  user_id     String
  category_id String
  content     String
  embedding   Json?
  created_at  DateTime       @default(now())
  user        User           @relation(fields: [user_id], references: [id])
  category    MemoryCategory @relation(fields: [category_id], references: [id])
}

model Knowledge {
  id         String   @id @default(uuid())
  user_id    String
  title      String
  content    String? // Used if the user pastes text
  file_url   String? // Used if the user uploads a file
  file_type  String? // pdf, txt, md, docx, etc.
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model MemoryActionsTaken {
  id          String   @id @default(uuid())
  user_id     String
  action_type String // e.g., "workflow_created", "workflow_updated", "suggestion_given"
  description String?
  metadata    Json?
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model MemoryStrategy {
  id         String   @id @default(uuid())
  user_id    String
  title      String
  content    String
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model MemoryAutomation {
  id          String   @id @default(uuid())
  user_id     String
  workflow_id String?
  title       String?
  description String?
  metadata    Json?
  created_at  DateTime @default(now())

  user     User       @relation(fields: [user_id], references: [id])
  workflow Workflows? @relation(fields: [workflow_id], references: [id])
}

model MemoryPainPoint {
  id         String   @id @default(uuid())
  user_id    String
  content    String
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model MemoryOpportunity {
  id         String   @id @default(uuid())
  user_id    String
  content    String
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model MemoryRoadmap {
  id         String   @id @default(uuid())
  user_id    String
  title      String
  content    String
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model CoreFramework {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  category    String              // e.g. "icp", "offer", "funnel_acquisition"
  tags        String[]            // e.g. ["b2b", "agency", "early_stage"]
  content     Json                // full structured framework JSON
  sourceType  String              // "book" | "article" | "operator" | "internal"
  sourceRef   String?             // URL, book ref, or note
  confidence  Float   @default(0.9)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
