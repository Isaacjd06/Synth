generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SubscriptionStatus {
  SUBSCRIBED
  UNSUBSCRIBED
}

model CoreFramework {
  id         String   @id
  slug       String   @unique
  title      String
  category   String
  tags       String[]
  content    Json
  sourceType String
  sourceRef  String?
  confidence Float    @default(0.9)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model MemoryActionsTaken {
  id          String   @id
  user_id     String
  action_type String
  description String?
  metadata    Json?
  created_at  DateTime @default(now())
  User        User     @relation(fields: [user_id], references: [id])
}

model MemoryAutomation {
  id          String     @id
  user_id     String
  workflow_id String?
  title       String?
  description String?
  metadata    Json?
  created_at  DateTime   @default(now())
  User        User       @relation(fields: [user_id], references: [id])
  workflows   workflows? @relation(fields: [workflow_id], references: [id])
}

model MemoryCategory {
  id          String       @id
  user_id     String
  name        String
  description String?
  created_at  DateTime     @default(now())
  User        User         @relation(fields: [user_id], references: [id])
  MemoryItem  MemoryItem[]
}

model MemoryItem {
  id             String         @id
  user_id        String
  category_id    String
  content        String
  embedding      Json?
  created_at     DateTime       @default(now())
  MemoryCategory MemoryCategory @relation(fields: [category_id], references: [id])
  User           User           @relation(fields: [user_id], references: [id])
}

model MemoryOpportunity {
  id         String   @id
  user_id    String
  content    String
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id])
}

model MemoryPainPoint {
  id         String   @id
  user_id    String
  content    String
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id])
}

model MemoryRoadmap {
  id         String   @id
  user_id    String
  title      String
  content    String
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id])
}

model MemoryStrategy {
  id         String   @id
  user_id    String
  title      String
  content    String
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id])
}

model User {
  id                          String                        @id
  email                       String                        @unique
  name                        String?
  google_id                   String?                       @unique
  avatar_url                  String?
  email_verified              Boolean?                      @default(false)
  provider                    String?                       @default("google")
  last_login_at               DateTime?                     @default(now())
  created_at                  DateTime                      @default(now())
  stripe_customer_id          String?
  stripe_subscription_id      String?
  subscription_ends_at        DateTime?
  subscription_plan           String?
  subscription_started_at     DateTime?
  subscription_status         String?                       @default("inactive")
  subscriptionStatus          SubscriptionStatus            @default(UNSUBSCRIBED)
  trial_ends_at               DateTime?
  stripe_payment_method_id    String?
  subscription_renewal_at     DateTime?
  subscription_add_ons        String[]                      @default([])
  has_active_payment_method   Boolean                       @default(false)
  last_plan_change_at         DateTime?
  payment_method_added_at     DateTime?
  pending_subscription_plan   String?
  executions                  executions[]
  knowledge                   knowledge[]
  MemoryActionsTaken          MemoryActionsTaken[]
  MemoryAutomation            MemoryAutomation[]
  MemoryCategory              MemoryCategory[]
  MemoryItem                  MemoryItem[]
  MemoryOpportunity           MemoryOpportunity[]
  MemoryPainPoint             MemoryPainPoint[]
  MemoryRoadmap               MemoryRoadmap[]
  MemoryStrategy              MemoryStrategy[]
  accounts                    Account[]
  advisory_insights           advisory_insights[]
  api_keys                    api_keys[]
  audit_logs                  audit_logs[]
  business_rules              business_rules[]
  chat_messages               chat_messages[]
  connections                 connections[]
  glossary                    glossary[]
  knowledge_files             knowledge_files[]
  memory                      memory[]
  purchase_logs               purchase_logs[]
  sessions                    Session[]
  structured_knowledge        structured_knowledge[]
  subscription_cancel_reasons subscription_cancel_reasons[]
  usage_logs                  usage_logs[]
  workflow_learned_patterns   workflow_learned_patterns[]
  workflows                   workflows[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model advisory_insights {
  id          String   @id
  user_id     String
  source_type String
  title       String
  body        String
  priority    String?  @default("medium")
  category    String?
  metadata    Json?
  created_at  DateTime @default(now())
  User        User     @relation(fields: [user_id], references: [id])

  @@index([source_type, created_at])
  @@index([user_id, created_at])
}

model api_keys {
  id           String    @id
  user_id      String
  name         String
  key_hash     String
  key_prefix   String
  scopes       String[]  @default([])
  last_used_at DateTime?
  expires_at   DateTime?
  revoked      Boolean   @default(false)
  created_at   DateTime  @default(now())
  User         User      @relation(fields: [user_id], references: [id])

  @@index([key_prefix])
  @@index([user_id])
}

model audit_logs {
  id            String   @id
  user_id       String?
  action        String
  resource_type String?
  resource_id   String?
  ip_address    String?
  user_agent    String?
  metadata      Json?
  created_at    DateTime @default(now())
  User          User?    @relation(fields: [user_id], references: [id])

  @@index([action, created_at])
  @@index([resource_type, resource_id])
  @@index([user_id, created_at])
}

model chat_messages {
  id              String   @id
  user_id         String
  role            String
  content         String
  conversation_id String?
  created_at      DateTime @default(now())
  metadata        Json?
  User            User     @relation(fields: [user_id], references: [id])
}

model connections {
  id                  String    @id
  user_id             String
  service_name        String
  status              String    @default("active")
  connection_type     String?
  created_at          DateTime  @default(now())
  last_verified       DateTime?
  metadata            Json?
  pipedream_auth_id   String?
  pipedream_source_id String?
  User                User      @relation(fields: [user_id], references: [id])
}

model executions {
  id                     String    @id
  workflow_id            String
  user_id                String
  input_data             Json?
  output_data            Json?
  status                 String    @default("unknown")
  pipedream_execution_id String?
  created_at             DateTime  @default(now())
  finished_at            DateTime?
  error_message          String?
  execution_time_ms      Int?
  started_at             DateTime?
  User                   User      @relation(fields: [user_id], references: [id])
  workflows              workflows @relation(fields: [workflow_id], references: [id])

  @@index([status, created_at])
  @@index([user_id, created_at])
  @@index([workflow_id, created_at])
  @@map("Execution")
}

model knowledge {
  id         String   @id
  user_id    String
  title      String
  content    String?
  file_url   String?
  file_type  String?
  created_at DateTime @default(now())
  metadata   Json?
  type       String   @default("text")
  updated_at DateTime
  User       User     @relation(fields: [user_id], references: [id])

  @@map("Knowledge")
}

model business_rules {
  id         String   @id @default(uuid())
  user_id    String
  content    String
  priority   String   @default("medium")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
}

model glossary {
  id         String   @id @default(uuid())
  user_id    String
  term       String
  definition String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, term])
  @@index([user_id])
  @@index([term])
}

model knowledge_files {
  id                String   @id @default(uuid())
  user_id           String
  filename          String
  file_type         String
  file_size         Int
  storage_path      String?
  processed_content String?
  status            String   @default("uploading")
  error_message     String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  User              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([status])
}

model structured_knowledge {
  id         String   @id @default(uuid())
  user_id    String
  type       String
  data       Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, type])
  @@index([user_id, created_at])
}

model memory {
  id              String    @id
  user_id         String
  context_type    String
  content         Json
  relevance_score Float?
  created_at      DateTime  @default(now())
  last_accessed   DateTime?
  metadata        Json?
  User            User      @relation(fields: [user_id], references: [id])
}

model purchase_logs {
  id                       String   @id
  user_id                  String
  addon_id                 String
  stripe_payment_intent_id String?
  amount                   Int?
  currency                 String?  @default("usd")
  status                   String   @default("succeeded")
  created_at               DateTime @default(now())
  User                     User     @relation(fields: [user_id], references: [id])

  @@index([addon_id])
  @@index([user_id, created_at])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model stripe_events {
  id              String   @id
  stripe_event_id String   @unique
  type            String
  data            Json
  processed       Boolean  @default(false)
  created_at      DateTime @default(now())
}

model subscription_cancel_reasons {
  id         String   @id
  user_id    String
  reason     String
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id])

  @@index([user_id, created_at])
}

model usage_logs {
  id         String   @id
  user_id    String
  event      String
  amount     Int      @default(1)
  created_at DateTime @default(now())
  User       User     @relation(fields: [user_id], references: [id])

  @@index([event, created_at])
  @@index([user_id, created_at])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model waitlist {
  id        String   @id
  email     String   @unique
  createdAt DateTime @default(now())
  name      String?
  source    String?  @default("landing_page")
  status    String   @default("waiting")
  updatedAt DateTime
}

model webhook_event_logs {
  id              String    @id
  stripe_event_id String    @unique
  event_type      String
  processed       Boolean   @default(false)
  processed_at    DateTime?
  error_message   String?
  created_at      DateTime  @default(now())

  @@index([event_type, processed])
  @@index([stripe_event_id])
}

model workflows {
  id                         String                      @id
  user_id                    String
  name                       String
  description                String?
  intent                     String?
  trigger                    Json?
  actions                    Json?
  active                     Boolean                     @default(false)
  n8n_workflow_id            String?
  created_at                 DateTime                    @default(now())
  updated_at                 DateTime
  created_by_ai              Boolean                     @default(false)
  last_deployed_at           DateTime?
  pipedream_deployment_state String?
  executions                 executions[]
  MemoryAutomation           MemoryAutomation[]
  learned_patterns           workflow_learned_patterns[]
  User                       User                        @relation(fields: [user_id], references: [id])

  @@index([user_id, active])
  @@index([created_by_ai])
}

model workflow_learned_patterns {
  id                   String     @id @default(uuid())
  user_id              String
  pattern_type         String
  pattern_name         String
  pattern_description  String?
  extracted_data       Json
  source_workflow_id   String?
  source_workflow_name String?
  usage_count          Int        @default(1)
  confidence_score     Float      @default(0.5)
  tags                 String[]
  created_at           DateTime   @default(now())
  updated_at           DateTime   @updatedAt
  last_used_at         DateTime?
  workflows            workflows? @relation(fields: [source_workflow_id], references: [id])
  User                 User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, pattern_type])
  @@index([pattern_type, usage_count])
  @@index([source_workflow_id])
}
